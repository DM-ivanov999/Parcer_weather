<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UV Weather Admin</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; padding: 20px; }
  .container { max-width: 1100px; margin: 0 auto; }
  h1 { font-size: 1.5rem; margin-bottom: 20px; }
  h2 { font-size: 1.1rem; margin-bottom: 10px; color: #555; }

  /* Setup panel */
  .setup { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
  .setup input { width: 100%; padding: 8px; margin: 4px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
  .setup button { margin-top: 8px; }
  .setup.connected { background: #d4edda; border-color: #28a745; }

  /* Cards */
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
  @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
  .card { background: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

  /* Tables */
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th, td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #eee; }
  th { font-weight: 600; color: #666; font-size: 11px; text-transform: uppercase; }
  th.sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
  th.sortable:hover { background: #f8f9fa; }
  th.sortable::after { content: 'â‡…'; position: absolute; right: 6px; opacity: 0.3; font-size: 10px; }
  th.sortable.asc::after { content: 'â†‘'; opacity: 1; }
  th.sortable.desc::after { content: 'â†“'; opacity: 1; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .badge-green { background: #d4edda; color: #155724; }
  .badge-gray { background: #e9ecef; color: #6c757d; }
  .badge-low { background: #d4edda; color: #155724; }
  .badge-moderate { background: #fff3cd; color: #856404; }
  .badge-high { background: #f8d7da; color: #721c24; }
  .badge-veryhigh { background: #f5c6cb; color: #721c24; }
  .badge-extreme { background: #721c24; color: #fff; }

  /* Buttons */
  button, .btn { padding: 6px 14px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
  .btn-primary { background: #007bff; color: #fff; }
  .btn-primary:hover { background: #0056b3; }
  .btn-danger { background: #dc3545; color: #fff; }
  .btn-danger:hover { background: #c82333; }
  .btn-success { background: #28a745; color: #fff; }
  .btn-success:hover { background: #218838; }
  .btn-sm { padding: 3px 8px; font-size: 11px; }
  .btn-outline { background: transparent; border: 1px solid #ccc; color: #666; }
  .btn-outline:hover { background: #f0f0f0; }

  /* Forms */
  .form-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: end; }
  .form-row input { flex: 1; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
  .form-row label { display: block; font-size: 11px; color: #666; margin-bottom: 2px; }
  .form-group { flex: 1; }

  /* Actions bar */
  .actions { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
  .status { font-size: 12px; color: #666; margin-left: auto; }
  .clickable { cursor: pointer; }
  .clickable:hover { background: #f8f9fa; }

  /* Pagination */
  .pagination-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; font-size: 12px; }
  .pagination-controls { display: flex; gap: 6px; align-items: center; }
  .pagination-controls button { padding: 4px 10px; font-size: 11px; }
  .pagination-controls button:disabled { opacity: 0.4; cursor: not-allowed; }
  .pagination-info { color: #666; }
  .page-size-selector { display: flex; gap: 6px; align-items: center; }
  .page-size-selector select { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; cursor: pointer; }
</style>
</head>
<body>
<div class="container">
  <h1>UV Weather Admin</h1>

  <!-- Setup -->
  <div class="setup" id="setupPanel">
    <h2>Connection Settings</h2>
    <input type="text" id="inputUrl" placeholder="Supabase URL (https://xxx.supabase.co)">
    <input type="password" id="inputKey" placeholder="Supabase service_role key">
    <input type="text" id="inputGhToken" placeholder="GitHub Token (optional, for workflow control)">
    <input type="text" id="inputGhRepo" placeholder="GitHub Repo (e.g. DM-ivanov999/Parcer_weather)">
    <button class="btn btn-primary" onclick="connect()">Connect</button>
    <button class="btn btn-outline" onclick="clearSettings()">Clear</button>
  </div>

  <!-- Actions -->
  <div class="actions" id="actionsBar" style="display:none;">
    <button class="btn btn-success" onclick="runWorkflow()">Run Parser Now</button>
    <button class="btn btn-outline" onclick="refreshAll()">Refresh Data</button>
    <span class="status" id="statusText"></span>
  </div>

  <!-- Main grid -->
  <div class="grid">
    <!-- Current UV Data -->
    <div class="card" id="dataCard" style="grid-column: 1 / -1;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h2 style="margin:0;">Current UV Data</h2>
        <span id="lastUpdate" style="font-size:11px;color:#999;"></span>
      </div>
      <table>
        <thead><tr>
          <th class="sortable" onclick="sortData('city')">City</th>
          <th class="sortable" onclick="sortData('country')">Country</th>
          <th class="sortable" onclick="sortData('uv')">UV Index</th>
          <th class="sortable" onclick="sortData('temp')">Temp</th>
          <th class="sortable" onclick="sortData('humidity')">Humidity</th>
          <th class="sortable" onclick="sortData('wind')">Wind</th>
          <th class="sortable" onclick="sortData('weather')">Weather</th>
          <th class="sortable" onclick="sortData('updated')">Updated</th>
        </tr></thead>
        <tbody id="dataBody"><tr><td colspan="8" style="color:#999">Connect to load data...</td></tr></tbody>
      </table>
      <div class="pagination-bar" id="dataPagination" style="display:none;">
        <div class="page-size-selector">
          <span>Show:</span>
          <select id="dataPageSize" onchange="changeDataPageSize()">
            <option value="15">15</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span>per page</span>
        </div>
        <div class="pagination-info" id="dataPageInfo"></div>
        <div class="pagination-controls">
          <button class="btn btn-outline btn-sm" onclick="changeDataPage(-1)" id="dataPrevBtn">â† Prev</button>
          <button class="btn btn-outline btn-sm" onclick="changeDataPage(1)" id="dataNextBtn">Next â†’</button>
        </div>
      </div>
    </div>

    <!-- Countries -->
    <div class="card" id="countriesCard">
      <h2>Countries</h2>
      <div class="form-row">
        <div class="form-group"><label>Name</label><input id="countryName" placeholder="India"></div>
        <div class="form-group"><label>Code</label><input id="countryCode" placeholder="IN" maxlength="2" style="text-transform:uppercase"></div>
        <button class="btn btn-primary" onclick="addCountry()" style="align-self:end;">Add</button>
      </div>
      <table>
        <thead><tr>
          <th class="sortable" onclick="sortCountries('name')">Country</th>
          <th class="sortable" onclick="sortCountries('code')">Code</th>
          <th class="sortable" onclick="sortCountries('status')">Status</th>
          <th class="sortable" onclick="sortCountries('cities')">Cities</th>
          <th></th>
        </tr></thead>
        <tbody id="countriesBody"><tr><td colspan="5" style="color:#999">Loading...</td></tr></tbody>
      </table>
      <div class="pagination-bar" id="countriesPagination" style="display:none;">
        <div class="page-size-selector">
          <span>Show:</span>
          <select id="countriesPageSize" onchange="changeCountriesPageSize()">
            <option value="15" selected>15</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span>per page</span>
        </div>
        <div class="pagination-info" id="countriesPageInfo"></div>
        <div class="pagination-controls">
          <button class="btn btn-outline btn-sm" onclick="changeCountriesPage(-1)" id="countriesPrevBtn">â† Prev</button>
          <button class="btn btn-outline btn-sm" onclick="changeCountriesPage(1)" id="countriesNextBtn">Next â†’</button>
        </div>
      </div>
    </div>

    <!-- Cities -->
    <div class="card" id="citiesCard">
      <h2>Cities</h2>
      <div class="form-row">
        <div class="form-group"><label>Name</label><input id="cityName" placeholder="Mumbai"></div>
        <div class="form-group"><label>Country</label>
          <select id="cityCountrySelect" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px;">
            <option value="">Select country...</option>
          </select>
        </div>
        <div class="form-group"><label>Lat</label><input id="cityLat" placeholder="28.61" type="number" step="any"></div>
        <div class="form-group"><label>Lon</label><input id="cityLon" placeholder="77.20" type="number" step="any"></div>
        <button class="btn btn-primary" onclick="addCity()" style="align-self:end;">Add</button>
      </div>
      <table>
        <thead><tr>
          <th class="sortable" onclick="sortCities('name')">City</th>
          <th class="sortable" onclick="sortCities('country')">Country</th>
          <th class="sortable" onclick="sortCities('lat')">Lat</th>
          <th class="sortable" onclick="sortCities('lon')">Lon</th>
          <th class="sortable" onclick="sortCities('status')">Status</th>
          <th></th>
        </tr></thead>
        <tbody id="citiesBody"><tr><td colspan="6" style="color:#999">Loading...</td></tr></tbody>
      </table>
      <div class="pagination-bar" id="citiesPagination" style="display:none;">
        <div class="page-size-selector">
          <span>Show:</span>
          <select id="citiesPageSize" onchange="changeCitiesPageSize()">
            <option value="15">15</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <span>per page</span>
        </div>
        <div class="pagination-info" id="citiesPageInfo"></div>
        <div class="pagination-controls">
          <button class="btn btn-outline btn-sm" onclick="changeCitiesPage(-1)" id="citiesPrevBtn">â† Prev</button>
          <button class="btn btn-outline btn-sm" onclick="changeCitiesPage(1)" id="citiesNextBtn">Next â†’</button>
        </div>
      </div>
    </div>

    <!-- DSP Mapping -->
    <div class="card">
      <h2>DSP City Mapping</h2>
      <div class="form-row">
        <div class="form-group"><label>DSP Name</label><input id="dspName" placeholder="New Delhi"></div>
        <div class="form-group"><label>Maps to City</label>
          <select id="dspCitySelect" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:13px;">
            <option value="">Select city...</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="addMapping()" style="align-self:end;">Add</button>
      </div>
      <table>
        <thead><tr><th>DSP Name</th><th>Maps to</th><th></th></tr></thead>
        <tbody id="mappingBody"><tr><td colspan="3" style="color:#999">Loading...</td></tr></tbody>
      </table>
    </div>

    <!-- API Documentation -->
    <div class="card" style="grid-column: 1 / -1;">
      <h2>API Documentation</h2>
      <p style="color:#666;font-size:13px;margin-bottom:16px;">
        Flexible weather API â€” request any combination of parameters (UV, temperature, humidity, etc.) for your banners or applications.
      </p>

      <details open style="margin-bottom:12px;">
        <summary style="cursor:pointer;font-weight:600;padding:8px;background:#e3f2fd;border-radius:4px;user-select:none;">
          ğŸŒ Single City â€” <code>get_weather_data</code>
        </summary>
        <div style="padding:12px;background:#f8f9fa;border-radius:4px;margin-top:8px;">
          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Endpoint:</strong></p>
          <code style="display:block;background:#fff;padding:8px;border-radius:4px;font-size:11px;overflow-x:auto;margin-bottom:12px;" class="api-endpoint">https://YOUR_PROJECT_ID.supabase.co/rest/v1/rpc/get_weather_data</code>

          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Example: UV only</strong></p>
          <pre style="background:#fff;padding:12px;border-radius:4px;font-size:11px;overflow-x:auto;margin-bottom:12px;"><code class="api-example">fetch('https://YOUR_PROJECT_ID.supabase.co/rest/v1/rpc/get_weather_data', {
  method: 'POST',
  headers: {
    'apikey': 'YOUR_ANON_KEY',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    p_city: 'Mumbai',
    p_fields: ['uv_index', 'uv_desc']
  })
})
.then(r => r.json())
.then(data => {
  if (data.ok) console.log(`${data.city}: UV ${data.uv_index}`);
});</code></pre>

          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Example: Temperature & Humidity</strong></p>
          <pre style="background:#fff;padding:12px;border-radius:4px;font-size:11px;overflow-x:auto;margin:0;"><code class="api-example">// Request only temperature and humidity
body: JSON.stringify({
  p_city: 'Delhi',
  p_fields: ['temperature', 'humidity', 'weather_desc']
})</code></pre>
        </div>
      </details>

      <details style="margin-bottom:12px;">
        <summary style="cursor:pointer;font-weight:600;padding:8px;background:#e3f2fd;border-radius:4px;user-select:none;">
          ğŸ—ºï¸ Multiple Cities â€” <code>get_weather_data_batch</code>
        </summary>
        <div style="padding:12px;background:#f8f9fa;border-radius:4px;margin-top:8px;">
          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Endpoint:</strong></p>
          <code style="display:block;background:#fff;padding:8px;border-radius:4px;font-size:11px;overflow-x:auto;margin-bottom:12px;" class="api-endpoint">https://YOUR_PROJECT_ID.supabase.co/rest/v1/rpc/get_weather_data_batch</code>

          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Example:</strong></p>
          <pre style="background:#fff;padding:12px;border-radius:4px;font-size:11px;overflow-x:auto;margin:0;"><code class="api-example">fetch('https://YOUR_PROJECT_ID.supabase.co/rest/v1/rpc/get_weather_data_batch', {
  method: 'POST',
  headers: {
    'apikey': 'YOUR_ANON_KEY',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    p_cities: ['Mumbai', 'Delhi', 'Bangalore'],
    p_fields: ['uv_index', 'temperature']  // optional
  })
})
.then(r => r.json())
.then(response => {
  console.log(`Loaded ${response.count} cities`);
  response.data.forEach(city => {
    if (city.ok) console.log(`${city.city}: ${city.temperature}Â°C`);
  });
});</code></pre>
        </div>
      </details>

      <details style="margin-bottom:12px;">
        <summary style="cursor:pointer;font-weight:600;padding:8px;background:#e3f2fd;border-radius:4px;user-select:none;">
          ğŸ´ All Cities from Country â€” <code>get_weather_data_by_country</code>
        </summary>
        <div style="padding:12px;background:#f8f9fa;border-radius:4px;margin-top:8px;">
          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Endpoint:</strong></p>
          <code style="display:block;background:#fff;padding:8px;border-radius:4px;font-size:11px;overflow-x:auto;margin-bottom:12px;" class="api-endpoint">https://YOUR_PROJECT_ID.supabase.co/rest/v1/rpc/get_weather_data_by_country</code>

          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Example:</strong></p>
          <pre style="background:#fff;padding:12px;border-radius:4px;font-size:11px;overflow-x:auto;margin:0;"><code class="api-example">fetch('https://YOUR_PROJECT_ID.supabase.co/rest/v1/rpc/get_weather_data_by_country', {
  method: 'POST',
  headers: {
    'apikey': 'YOUR_ANON_KEY',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    p_country_code: 'IN',  // ISO 3166-1 alpha-2
    p_fields: ['uv_index', 'temperature']  // optional
  })
})
.then(r => r.json())
.then(response => {
  console.log(`${response.country} (${response.code}): ${response.count} cities`);
  response.data.forEach(city => {
    console.log(`${city.city}: UV ${city.uv_index}, ${city.temperature}Â°C`);
  });
});</code></pre>
        </div>
      </details>

      <details style="margin-bottom:12px;">
        <summary style="cursor:pointer;font-weight:600;padding:8px;background:#f8f9fa;border-radius:4px;user-select:none;">
          ğŸ¯ Available Fields
        </summary>
        <div style="padding:12px;background:#f8f9fa;border-radius:4px;margin-top:8px;">
          <p style="font-size:12px;margin-bottom:8px;">Use <code>p_fields</code> parameter to request only specific fields:</p>
          <ul style="font-size:12px;margin:0;padding-left:20px;">
            <li><code>uv_index</code> â€” UV index value (number)</li>
            <li><code>uv_desc</code> â€” UV description (Low, Moderate, High, Very High, Extreme)</li>
            <li><code>temperature</code> â€” Temperature in Â°C</li>
            <li><code>feels_like</code> â€” Apparent temperature in Â°C</li>
            <li><code>humidity</code> â€” Relative humidity (%)</li>
            <li><code>wind_speed</code> â€” Wind speed (km/h)</li>
            <li><code>weather_desc</code> â€” Weather description (Clear sky, Rain, etc.)</li>
            <li><code>updated_at</code> â€” Last update timestamp</li>
          </ul>
          <p style="font-size:11px;color:#999;margin-top:8px;">ğŸ’¡ If <code>p_fields</code> is not specified or <code>null</code>, all fields are returned.</p>
        </div>
      </details>

      <details style="margin-bottom:12px;">
        <summary style="cursor:pointer;font-weight:600;padding:8px;background:#f8f9fa;border-radius:4px;user-select:none;">
          ğŸ”— Legacy Endpoint (still works)
        </summary>
        <div style="padding:12px;background:#f8f9fa;border-radius:4px;margin-top:8px;">
          <p style="font-size:12px;margin-bottom:8px;">Old <code>get_uv_for_banner</code> endpoint still works for backward compatibility:</p>
          <code style="display:block;background:#fff;padding:8px;border-radius:4px;font-size:11px;overflow-x:auto;">https://YOUR_PROJECT_ID.supabase.co/rest/v1/rpc/get_uv_for_banner?p_city=Mumbai</code>
          <p style="font-size:11px;color:#999;margin-top:8px;">âš ï¸ Use new <code>get_weather_data</code> for better flexibility.</p>
        </div>
      </details>

      <details>
        <summary style="cursor:pointer;font-weight:600;padding:8px;background:#f8f9fa;border-radius:4px;user-select:none;">
          ğŸ“„ Response Examples
        </summary>
        <div style="padding:12px;background:#f8f9fa;border-radius:4px;margin-top:8px;">
          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Single city success:</strong></p>
          <pre style="background:#fff;padding:12px;border-radius:4px;font-size:11px;overflow-x:auto;margin-bottom:12px;"><code>{
  "ok": true,
  "city": "Mumbai",
  "country": "India",
  "uv_index": 7.5,
  "temperature": 32.1
}</code></pre>

          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Batch response:</strong></p>
          <pre style="background:#fff;padding:12px;border-radius:4px;font-size:11px;overflow-x:auto;margin-bottom:12px;"><code>{
  "ok": true,
  "count": 3,
  "data": [
    { "ok": true, "city": "Mumbai", "country": "India", "uv_index": 7.5 },
    { "ok": true, "city": "Delhi", "country": "India", "uv_index": 6.2 },
    { "ok": false, "error": "City \"Unknown\" not found or inactive" }
  ]
}</code></pre>

          <p style="font-size:12px;color:#666;margin-bottom:8px;"><strong>Country response:</strong></p>
          <pre style="background:#fff;padding:12px;border-radius:4px;font-size:11px;overflow-x:auto;margin:0;"><code>{
  "ok": true,
  "country": "India",
  "code": "IN",
  "count": 17,
  "data": [
    { "city": "Ahmedabad", "uv_index": 8.1, "temperature": 35.2 },
    { "city": "Bangalore", "uv_index": 6.5, "temperature": 28.4 },
    ...
  ]
}</code></pre>
        </div>
      </details>
    </div>
  </div>
</div>

<script>
let sb = null;
let ghToken = '';
let ghRepo = '';
let allCities = [];
let allCountries = [];
let uvData = [];
let sortColumn = 'updated';
let sortDirection = 'desc';
let countriesSortColumn = 'name';
let countriesSortDirection = 'asc';
let citiesSortColumn = 'name';
let citiesSortDirection = 'asc';

// Pagination state
let dataPage = 1;
let dataPageSize = 25;
let countriesPage = 1;
let countriesPageSize = 15;
let citiesPage = 1;
let citiesPageSize = 25;

function getSettings() {
  return {
    url: localStorage.getItem('sb_url') || '',
    key: localStorage.getItem('sb_key') || '',
    ghToken: localStorage.getItem('gh_token') || '',
    ghRepo: localStorage.getItem('gh_repo') || 'DM-ivanov999/Parcer_weather',
  };
}

function connect() {
  const url = document.getElementById('inputUrl').value.trim() || getSettings().url;
  const key = document.getElementById('inputKey').value.trim() || getSettings().key;
  ghToken = document.getElementById('inputGhToken').value.trim() || getSettings().ghToken;
  ghRepo = document.getElementById('inputGhRepo').value.trim() || getSettings().ghRepo;

  if (!url || !key) { alert('Supabase URL and Key are required'); return; }

  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  if (ghToken) localStorage.setItem('gh_token', ghToken);
  if (ghRepo) localStorage.setItem('gh_repo', ghRepo);

  sb = supabase.createClient(url, key);
  document.getElementById('setupPanel').classList.add('connected');
  document.getElementById('setupPanel').querySelector('h2').textContent = 'Connected to Supabase';
  document.getElementById('actionsBar').style.display = 'flex';
  updateApiExamples();
  refreshAll();
}

function clearSettings() {
  localStorage.removeItem('sb_url');
  localStorage.removeItem('sb_key');
  localStorage.removeItem('gh_token');
  localStorage.removeItem('gh_repo');
  location.reload();
}

function setStatus(msg) {
  document.getElementById('statusText').textContent = msg;
}

function updateApiExamples() {
  const s = getSettings();
  if (!s.url || !s.key) return;

  // Update all code examples with real URL and key
  const examples = document.querySelectorAll('.api-endpoint, .api-example, code');
  examples.forEach(el => {
    el.textContent = el.textContent
      .replace(/YOUR_PROJECT_ID\.supabase\.co/g, s.url.replace('https://', '').replace('http://', ''))
      .replace(/https:\/\/YOUR_PROJECT_ID\.supabase\.co/g, s.url)
      .replace(/YOUR_ANON_KEY/g, s.key);
  });
}

// â”€â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  const { data, error } = await sb
    .from('uv_data')
    .select('*, cities(name, countries(name))')
    .order('city_id');

  if (error) { setStatus('Error: ' + error.message); return; }
  const tbody = document.getElementById('dataBody');
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="8" style="color:#999">No data yet. Run the parser first.</td></tr>';
    document.getElementById('lastUpdate').textContent = '';
    uvData = [];
    return;
  }

  // Store data globally
  uvData = data;

  // Find most recent update
  const timestamps = data.map(r => r.updated_at).filter(Boolean);
  if (timestamps.length > 0) {
    const latest = new Date(Math.max(...timestamps.map(t => new Date(t))));
    const formatted = latest.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
    const ago = timeAgo(latest.toISOString());
    document.getElementById('lastUpdate').textContent = `Last update: ${formatted} (${ago})`;
  }

  // Render sorted data
  renderDataTable();
}

function renderDataTable() {
  const tbody = document.getElementById('dataBody');
  if (!uvData.length) return;

  // Sort data
  const sorted = [...uvData].sort((a, b) => {
    let aVal, bVal;

    switch (sortColumn) {
      case 'city':
        aVal = a.cities?.name || '';
        bVal = b.cities?.name || '';
        break;
      case 'country':
        aVal = a.cities?.countries?.name || '';
        bVal = b.cities?.countries?.name || '';
        break;
      case 'uv':
        aVal = a.uv_index || 0;
        bVal = b.uv_index || 0;
        break;
      case 'temp':
        aVal = a.temperature || 0;
        bVal = b.temperature || 0;
        break;
      case 'humidity':
        aVal = a.humidity || 0;
        bVal = b.humidity || 0;
        break;
      case 'wind':
        aVal = a.wind_speed || 0;
        bVal = b.wind_speed || 0;
        break;
      case 'weather':
        aVal = a.weather_desc || '';
        bVal = b.weather_desc || '';
        break;
      case 'updated':
        aVal = new Date(a.updated_at || 0).getTime();
        bVal = new Date(b.updated_at || 0).getTime();
        break;
      default:
        return 0;
    }

    // Compare
    let result = 0;
    if (typeof aVal === 'string') {
      result = aVal.localeCompare(bVal);
    } else {
      result = aVal - bVal;
    }

    return sortDirection === 'asc' ? result : -result;
  });

  // Update sort indicators
  document.querySelectorAll('#dataCard th.sortable').forEach(th => {
    th.classList.remove('asc', 'desc');
  });
  const activeHeader = Array.from(document.querySelectorAll('#dataCard th.sortable')).find(th => {
    const onclick = th.getAttribute('onclick');
    return onclick && onclick.includes(`'${sortColumn}'`);
  });
  if (activeHeader) {
    activeHeader.classList.add(sortDirection);
  }

  // Pagination
  const totalItems = sorted.length;
  const totalPages = Math.ceil(totalItems / dataPageSize);
  dataPage = Math.max(1, Math.min(dataPage, totalPages || 1));
  const startIdx = (dataPage - 1) * dataPageSize;
  const endIdx = startIdx + dataPageSize;
  const pageData = sorted.slice(startIdx, endIdx);

  // Show/hide pagination
  const paginationBar = document.getElementById('dataPagination');
  if (totalItems > 0) {
    paginationBar.style.display = 'flex';
    document.getElementById('dataPageInfo').textContent =
      `${startIdx + 1}-${Math.min(endIdx, totalItems)} of ${totalItems}`;
    document.getElementById('dataPrevBtn').disabled = dataPage === 1;
    document.getElementById('dataNextBtn').disabled = dataPage === totalPages;
  } else {
    paginationBar.style.display = 'none';
  }

  // Render rows
  tbody.innerHTML = pageData.map(r => {
    const cls = (r.uv_desc || 'low').toLowerCase().replace(' ', '');
    const ago = timeAgo(r.updated_at);
    const country = r.cities?.countries?.name || '?';
    return `<tr>
      <td><strong>${r.cities?.name || '?'}</strong></td>
      <td style="color:#999;font-size:11px">${country}</td>
      <td><span class="badge badge-${cls}">${r.uv_index} ${r.uv_desc}</span></td>
      <td>${r.temperature}Â°C</td>
      <td>${r.humidity}%</td>
      <td>${r.wind_speed} km/h</td>
      <td>${r.weather_desc}</td>
      <td style="color:#999;font-size:11px">${ago}</td>
    </tr>`;
  }).join('');
}

function sortData(column) {
  if (sortColumn === column) {
    // Toggle direction
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    // New column, default to descending (except for text columns)
    sortColumn = column;
    sortDirection = ['city', 'country', 'weather'].includes(column) ? 'asc' : 'desc';
  }
  dataPage = 1; // Reset to first page on sort
  renderDataTable();
}

function changeDataPage(delta) {
  dataPage += delta;
  renderDataTable();
}

function changeDataPageSize() {
  dataPageSize = parseInt(document.getElementById('dataPageSize').value);
  dataPage = 1; // Reset to first page
  renderDataTable();
}

// â”€â”€â”€ Countries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCountries() {
  const { data, error } = await sb
    .from('countries')
    .select('*, cities(id)')
    .order('active', { ascending: false })
    .order('name');

  if (error) { setStatus('Error: ' + error.message); return; }
  allCountries = data;
  updateCountrySelect();
  renderCountriesTable();
}

function renderCountriesTable() {
  const tbody = document.getElementById('countriesBody');
  if (!allCountries.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="color:#999">No countries added yet.</td></tr>';
    document.getElementById('countriesPagination').style.display = 'none';
    return;
  }

  // Sort countries
  const sorted = [...allCountries].sort((a, b) => {
    let aVal, bVal;
    const cityCountA = a.cities?.length || 0;
    const cityCountB = b.cities?.length || 0;

    switch (countriesSortColumn) {
      case 'name':
        aVal = a.name || '';
        bVal = b.name || '';
        break;
      case 'code':
        aVal = a.code || '';
        bVal = b.code || '';
        break;
      case 'status':
        aVal = a.active ? 1 : 0;
        bVal = b.active ? 1 : 0;
        break;
      case 'cities':
        aVal = cityCountA;
        bVal = cityCountB;
        break;
      default:
        return 0;
    }

    let result = 0;
    if (typeof aVal === 'string') {
      result = aVal.localeCompare(bVal);
    } else {
      result = aVal - bVal;
    }

    return countriesSortDirection === 'asc' ? result : -result;
  });

  // Update sort indicators
  document.querySelectorAll('#countriesCard th.sortable').forEach(th => {
    th.classList.remove('asc', 'desc');
  });
  const activeHeader = Array.from(document.querySelectorAll('#countriesCard th.sortable')).find(th => {
    const onclick = th.getAttribute('onclick');
    return onclick && onclick.includes(`'${countriesSortColumn}'`);
  });
  if (activeHeader) {
    activeHeader.classList.add(countriesSortDirection);
  }

  // Pagination
  const totalItems = sorted.length;
  const totalPages = Math.ceil(totalItems / countriesPageSize);
  countriesPage = Math.max(1, Math.min(countriesPage, totalPages || 1));
  const startIdx = (countriesPage - 1) * countriesPageSize;
  const endIdx = startIdx + countriesPageSize;
  const pageData = sorted.slice(startIdx, endIdx);

  // Show/hide pagination
  const paginationBar = document.getElementById('countriesPagination');
  if (totalItems > 0) {
    paginationBar.style.display = 'flex';
    document.getElementById('countriesPageInfo').textContent =
      `${startIdx + 1}-${Math.min(endIdx, totalItems)} of ${totalItems}`;
    document.getElementById('countriesPrevBtn').disabled = countriesPage === 1;
    document.getElementById('countriesNextBtn').disabled = countriesPage === totalPages;
  } else {
    paginationBar.style.display = 'none';
  }

  // Render rows
  tbody.innerHTML = pageData.map(co => {
    const cityCount = co.cities?.length || 0;
    return `<tr>
      <td><strong>${co.name}</strong></td>
      <td style="font-family:monospace;color:#999">${co.code}</td>
      <td>
        <span class="badge ${co.active ? 'badge-green' : 'badge-gray'} clickable"
              onclick="toggleCountry(${co.id}, ${!co.active})">${co.active ? 'Active' : 'Inactive'}</span>
      </td>
      <td style="color:#999;font-size:11px">${cityCount} cities</td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteCountry(${co.id})">x</button></td>
    </tr>`;
  }).join('');
}

function sortCountries(column) {
  if (countriesSortColumn === column) {
    countriesSortDirection = countriesSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    countriesSortColumn = column;
    countriesSortDirection = column === 'cities' ? 'desc' : 'asc';
  }
  countriesPage = 1; // Reset to first page on sort
  renderCountriesTable();
}

function changeCountriesPage(delta) {
  countriesPage += delta;
  renderCountriesTable();
}

function changeCountriesPageSize() {
  countriesPageSize = parseInt(document.getElementById('countriesPageSize').value);
  countriesPage = 1; // Reset to first page
  renderCountriesTable();
}

function updateCountrySelect() {
  const sel = document.getElementById('cityCountrySelect');
  sel.innerHTML = '<option value="">Select country...</option>' +
    allCountries.map(co => `<option value="${co.id}">${co.name} (${co.code})</option>`).join('');
}

async function addCountry() {
  const name = document.getElementById('countryName').value.trim();
  const code = document.getElementById('countryCode').value.trim().toUpperCase();
  if (!name || !code) { alert('Fill all fields'); return; }
  if (code.length !== 2) { alert('Code must be 2 letters (ISO 3166-1)'); return; }

  const { error } = await sb.from('countries').insert({ name, code, active: true });
  if (error) { alert('Error: ' + error.message); return; }
  document.getElementById('countryName').value = '';
  document.getElementById('countryCode').value = '';
  loadCountries();
  setStatus(`Country "${name}" added`);
}

async function toggleCountry(id, active) {
  // Update country status
  await sb.from('countries').update({ active }).eq('id', id);

  // Update all cities from this country
  await sb.from('cities').update({ active }).eq('country_id', id);

  if (active) {
    setStatus('Country activated â†’ all cities activated');
  } else {
    setStatus('Country deactivated â†’ all cities deactivated');
  }

  // Reload all data sequentially to ensure UI updates
  await loadCountries();
  await loadCities(); // Need to refresh cities table too
  await loadData(); // Refresh UV data as countries affect visibility
}

async function deleteCountry(id) {
  if (!confirm('Delete this country and all its cities?')) return;
  await sb.from('countries').delete().eq('id', id);
  loadCountries();
  loadCities();
  loadData();
}

// â”€â”€â”€ Cities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadCities() {
  const { data, error } = await sb
    .from('cities')
    .select('*, countries(name)')
    .order('name');

  if (error) { setStatus('Error: ' + error.message); return; }
  allCities = data;
  updateCitySelect();
  renderCitiesTable();
}

function renderCitiesTable() {
  const tbody = document.getElementById('citiesBody');
  if (!allCities.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="color:#999">No cities added yet.</td></tr>';
    document.getElementById('citiesPagination').style.display = 'none';
    return;
  }

  // Sort cities
  const sorted = [...allCities].sort((a, b) => {
    let aVal, bVal;

    switch (citiesSortColumn) {
      case 'name':
        aVal = a.name || '';
        bVal = b.name || '';
        break;
      case 'country':
        aVal = a.countries?.name || '';
        bVal = b.countries?.name || '';
        break;
      case 'lat':
        aVal = a.lat || 0;
        bVal = b.lat || 0;
        break;
      case 'lon':
        aVal = a.lon || 0;
        bVal = b.lon || 0;
        break;
      case 'status':
        aVal = a.active ? 1 : 0;
        bVal = b.active ? 1 : 0;
        break;
      default:
        return 0;
    }

    let result = 0;
    if (typeof aVal === 'string') {
      result = aVal.localeCompare(bVal);
    } else {
      result = aVal - bVal;
    }

    return citiesSortDirection === 'asc' ? result : -result;
  });

  // Update sort indicators
  document.querySelectorAll('#citiesCard th.sortable').forEach(th => {
    th.classList.remove('asc', 'desc');
  });
  const activeHeader = Array.from(document.querySelectorAll('#citiesCard th.sortable')).find(th => {
    const onclick = th.getAttribute('onclick');
    return onclick && onclick.includes(`'${citiesSortColumn}'`);
  });
  if (activeHeader) {
    activeHeader.classList.add(citiesSortDirection);
  }

  // Pagination
  const totalItems = sorted.length;
  const totalPages = Math.ceil(totalItems / citiesPageSize);
  citiesPage = Math.max(1, Math.min(citiesPage, totalPages || 1));
  const startIdx = (citiesPage - 1) * citiesPageSize;
  const endIdx = startIdx + citiesPageSize;
  const pageData = sorted.slice(startIdx, endIdx);

  // Show/hide pagination
  const paginationBar = document.getElementById('citiesPagination');
  if (totalItems > 0) {
    paginationBar.style.display = 'flex';
    document.getElementById('citiesPageInfo').textContent =
      `${startIdx + 1}-${Math.min(endIdx, totalItems)} of ${totalItems}`;
    document.getElementById('citiesPrevBtn').disabled = citiesPage === 1;
    document.getElementById('citiesNextBtn').disabled = citiesPage === totalPages;
  } else {
    paginationBar.style.display = 'none';
  }

  // Render rows
  tbody.innerHTML = pageData.map(c => {
    const country = c.countries?.name || '?';
    return `<tr>
      <td><strong>${c.name}</strong></td>
      <td style="color:#999;font-size:11px">${country}</td>
      <td>${c.lat}</td>
      <td>${c.lon}</td>
      <td>
        <span class="badge ${c.active ? 'badge-green' : 'badge-gray'} clickable"
              onclick="toggleCity(${c.id}, ${!c.active})">${c.active ? 'Active' : 'Inactive'}</span>
      </td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteCity(${c.id})">x</button></td>
    </tr>`;
  }).join('');
}

function sortCities(column) {
  if (citiesSortColumn === column) {
    citiesSortDirection = citiesSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    citiesSortColumn = column;
    citiesSortDirection = ['lat', 'lon'].includes(column) ? 'desc' : 'asc';
  }
  citiesPage = 1; // Reset to first page on sort
  renderCitiesTable();
}

function changeCitiesPage(delta) {
  citiesPage += delta;
  renderCitiesTable();
}

function changeCitiesPageSize() {
  citiesPageSize = parseInt(document.getElementById('citiesPageSize').value);
  citiesPage = 1; // Reset to first page
  renderCitiesTable();
}

function updateCitySelect() {
  const sel = document.getElementById('dspCitySelect');
  sel.innerHTML = '<option value="">Select city...</option>' +
    allCities.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

async function addCity() {
  const name = document.getElementById('cityName').value.trim();
  const country_id = parseInt(document.getElementById('cityCountrySelect').value);
  const lat = parseFloat(document.getElementById('cityLat').value);
  const lon = parseFloat(document.getElementById('cityLon').value);
  if (!name || !country_id || isNaN(lat) || isNaN(lon)) { alert('Fill all fields'); return; }

  const { error } = await sb.from('cities').insert({ name, country_id, lat, lon, active: true });
  if (error) { alert('Error: ' + error.message); return; }
  document.getElementById('cityName').value = '';
  document.getElementById('cityLat').value = '';
  document.getElementById('cityLon').value = '';
  loadCities();
  loadCountries(); // Refresh city count
  setStatus(`City "${name}" added`);
}

async function toggleCity(id, active) {
  // Update city status
  await sb.from('cities').update({ active }).eq('id', id);

  // If activating city, activate its country too
  if (active) {
    // Get city's country_id
    const { data: city } = await sb
      .from('cities')
      .select('country_id')
      .eq('id', id)
      .single();

    if (city) {
      // Activate the country
      await sb.from('countries').update({ active: true }).eq('id', city.country_id);
      setStatus('City activated â†’ country activated');
    }
  }

  // Reload all data sequentially to ensure UI updates
  await loadCities();
  await loadCountries(); // Need to refresh countries table too
}

async function deleteCity(id) {
  if (!confirm('Delete this city and its data?')) return;
  await sb.from('cities').delete().eq('id', id);
  loadCities();
  loadData();
}

// â”€â”€â”€ Mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMapping() {
  const { data, error } = await sb
    .from('city_mapping')
    .select('*, cities(name)')
    .order('dsp_name');

  if (error) { setStatus('Error: ' + error.message); return; }
  const tbody = document.getElementById('mappingBody');
  if (!data.length) { tbody.innerHTML = '<tr><td colspan="3" style="color:#999">No mappings yet.</td></tr>'; return; }

  tbody.innerHTML = data.map(m => `<tr>
    <td>${m.dsp_name}</td>
    <td>${m.cities?.name || '?'}</td>
    <td><button class="btn btn-danger btn-sm" onclick="deleteMapping(${m.id})">x</button></td>
  </tr>`).join('');
}

async function addMapping() {
  const dsp_name = document.getElementById('dspName').value.trim();
  const city_id = parseInt(document.getElementById('dspCitySelect').value);
  if (!dsp_name || !city_id) { alert('Fill DSP name and select city'); return; }

  const { error } = await sb.from('city_mapping').insert({ dsp_name, city_id });
  if (error) { alert('Error: ' + error.message); return; }
  document.getElementById('dspName').value = '';
  loadMapping();
  setStatus(`Mapping "${dsp_name}" added`);
}

async function deleteMapping(id) {
  await sb.from('city_mapping').delete().eq('id', id);
  loadMapping();
}

// â”€â”€â”€ GitHub Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runWorkflow() {
  if (!ghToken || !ghRepo) { alert('GitHub token and repo are required'); return; }
  setStatus('Triggering workflow...');

  const resp = await fetch(`https://api.github.com/repos/${ghRepo}/actions/workflows/uv_parser.yml/dispatches`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${ghToken}`,
      'Accept': 'application/vnd.github.v3+json',
    },
    body: JSON.stringify({ ref: 'main' }),
  });

  if (resp.ok || resp.status === 204) {
    setStatus('Workflow triggered! Check GitHub Actions.');
  } else {
    const err = await resp.json().catch(() => ({}));
    setStatus('Error: ' + (err.message || resp.status));
  }
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeAgo(ts) {
  if (!ts) return 'â€”';
  const diff = (Date.now() - new Date(ts).getTime()) / 1000;
  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}

async function refreshAll() {
  setStatus('Loading...');
  await Promise.all([loadData(), loadCountries(), loadCities(), loadMapping()]);
  setStatus('Last refresh: ' + new Date().toLocaleTimeString());
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  const s = getSettings();
  document.getElementById('inputUrl').value = s.url;
  document.getElementById('inputKey').value = s.key;
  document.getElementById('inputGhToken').value = s.ghToken;
  document.getElementById('inputGhRepo').value = s.ghRepo;
  if (s.url && s.key) connect();
})();
</script>
</body>
</html>
